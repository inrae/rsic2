<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Import_offtakes â€¢ rsic2</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Import_offtakes">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">rsic2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/Import_offtakes.html">Import_offtakes</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">



<link href="Import_offtakes_files/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet">
<script src="Import_offtakes_files/htmlwidgets-1.6.4/htmlwidgets.js"></script><link href="Import_offtakes_files/leaflet-1.3.1/leaflet.css" rel="stylesheet">
<script src="Import_offtakes_files/leaflet-1.3.1/leaflet.js"></script><link href="Import_offtakes_files/leafletfix-1.0.0/leafletfix.css" rel="stylesheet">
<script src="Import_offtakes_files/proj4-2.6.2/proj4.min.js"></script><script src="Import_offtakes_files/Proj4Leaflet-1.0.1/proj4leaflet.js"></script><link href="Import_offtakes_files/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet">
<script src="Import_offtakes_files/leaflet-binding-2.2.2/leaflet.js"></script><div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Import_offtakes</h1>
            
      

      <div class="d-none name"><code>Import_offtakes.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># install.packages("pak")</span></span>
<span><span class="co"># pak::pak("inrae/rsic2")</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">rsic2</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="sic-project-definition">SIC project definition<a class="anchor" aria-label="anchor" href="#sic-project-definition"></a>
</h2>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cfg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/loadConfig.html">loadConfig</a></span><span class="op">(</span>sic_path <span class="op">=</span> <span class="st">"C:/DocDD/Inrae/SIC/Versions/Sic538i5"</span>, </span>
<span>                  xml_path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/getwd.html" class="external-link">getwd</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"test.xml"</span><span class="op">)</span>, </span>
<span>                  new_project <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="data-importation">Data importation<a class="anchor" aria-label="anchor" href="#data-importation"></a>
</h2>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">openxlsx2</span><span class="fu">::</span><span class="fu"><a href="https://janmarvin.github.io/openxlsx2/reference/wb_to_df.html" class="external-link">read_xlsx</a></span><span class="op">(</span><span class="st">"Data_ouvrages.xlsx"</span><span class="op">)</span></span>
<span><span class="va">df</span><span class="op">$</span><span class="va">id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"ouvrage"</span>, <span class="va">df</span><span class="op">$</span><span class="va">`ID Ouvrage`</span><span class="op">)</span></span></code></pre></div>
<p>Plot map</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rstudio.github.io/leaflet/" class="external-link">leaflet</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: package 'leaflet' was built under R version 4.4.3</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: package 'sf' was built under R version 4.4.3</span></span>
<span><span class="co">#&gt; Linking to GEOS 3.13.0, GDAL 3.10.1, PROJ 9.5.1; sf_use_s2() is TRUE</span></span>
<span><span class="va">sf_nodes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="va">df</span>, coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"X"</span>, <span class="st">"Y"</span><span class="op">)</span>, crs <span class="op">=</span> <span class="fl">2154</span><span class="op">)</span></span>
<span><span class="va">sf_nodes_wgs84</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="va">sf_nodes</span>, crs <span class="op">=</span> <span class="fl">4326</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rstudio.github.io/leaflet/reference/leaflet.html" class="external-link">leaflet</a></span><span class="op">(</span><span class="va">sf_nodes_wgs84</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rstudio.github.io/leaflet/reference/map-layers.html" class="external-link">addTiles</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rstudio.github.io/leaflet/reference/map-layers.html" class="external-link">addCircleMarkers</a></span><span class="op">(</span></span>
<span>    lng <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html" class="external-link">st_coordinates</a></span><span class="op">(</span><span class="va">sf_nodes_wgs84</span><span class="op">)</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>,</span>
<span>    lat <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html" class="external-link">st_coordinates</a></span><span class="op">(</span><span class="va">sf_nodes_wgs84</span><span class="op">)</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span>,</span>
<span>    label <span class="op">=</span> <span class="op">~</span> <span class="va">df</span><span class="op">$</span><span class="va">id</span>,</span>
<span>  <span class="op">)</span></span></code></pre></div>
<div class="leaflet html-widget html-fill-item" id="htmlwidget-ac96cb3ee4656e2e9ec3" style="width:700px;height:432.632880098888px;"></div>
<script type="application/json" data-for="htmlwidget-ac96cb3ee4656e2e9ec3">{"x":{"options":{"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}}},"calls":[{"method":"addTiles","args":["https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",null,null,{"minZoom":0,"maxZoom":18,"tileSize":256,"subdomains":"abc","errorTileUrl":"","tms":false,"noWrap":false,"zoomOffset":0,"zoomReverse":false,"opacity":1,"zIndex":1,"detectRetina":false,"attribution":"&copy; <a href=\"https://openstreetmap.org/copyright/\">OpenStreetMap<\/a>,  <a href=\"https://opendatacommons.org/licenses/odbl/\">ODbL<\/a>"}]},{"method":"addCircleMarkers","args":[[43.6652752376211,43.66488497782159,43.66449366417365,43.66414062440307,43.66415173157642,43.66247490708188,43.66237048202505,43.6611990404278,43.66040325644288,43.65996243368382,43.659898278212,43.65928132430457,43.65920344936877,43.6568894605598,43.65663960147534,43.65647730733778,43.65639285398827,43.6558845392291,43.65551912166237,43.65518351932182,43.65471621145381,43.65420201751744,43.65408627155819,43.65368899990048,43.65363742948089,43.652715876447,43.65228533687671,43.65228533687671,43.65221705212479,43.65094144384403,43.64951005087793,43.64946418440849,43.64943381127473,43.64704494532678,43.64703826126872,43.64510931773094,43.64447025058393,43.64387642796228,43.64387473265362,43.6438714598631,43.64305445377606,43.64305215551926,43.63968646722848,43.63926305125837,43.65373742856347,43.65387788540979,43.65387767446928,43.65407578006934,43.65406767083153,43.65407618593105,43.6539856003474,43.65313175674167,43.65300071996036,43.65142521673031,43.65130294529413,43.65127349818342,43.65101069187607,43.65019754813414,43.6499455206829,43.64993246379107,43.64819705778611,43.64819948006259,43.64819076748674,43.64752921652558,43.64753146578164,43.64641834879039,43.64638322091292,43.64581027393191,43.64580472062937,43.64569114353193,43.64402330410176,43.64227250115648,43.64165044545469,43.66412788499012,43.66269954231252,43.66293357790836,43.66323645630466,43.66325336396592,43.66331047328551,43.66331649298659,43.66332353595657,43.66310393855832,43.66305892311229,43.6530084107212,43.65371911485563,43.66331987718569,43.66380388171574],[4.470249038354413,4.470329687701589,4.470407742724565,4.470358098051743,4.470357973888762,4.473133416169922,4.473276466730598,4.475049951164977,4.476273342517727,4.476868294183829,4.476805813672081,4.476295209027526,4.476239640588592,4.476374384036965,4.476888343618037,4.477063646698472,4.477124711484183,4.477657423814293,4.478044784909473,4.478391027144972,4.47886469672339,4.479408220761117,4.479559896325457,4.479980174227829,4.480052467535953,4.479532658531879,4.479247679557049,4.479247679557049,4.479199773153147,4.478287619426735,4.47723946049156,4.477191467188551,4.477194762148693,4.476395055210025,4.476398179701873,4.475186279802409,4.475274183935632,4.475404901884698,4.475391226393811,4.475398961910215,4.475605017327626,4.475613223929564,4.476430274304369,4.476514477535687,4.47999390601702,4.481705421841643,4.481974494809285,4.48476062026923,4.484784394244821,4.484790874186078,4.48523869537676,4.485964057050655,4.486043977018372,4.487033795337715,4.487134078522471,4.487147939849141,4.487184898716796,4.487342067951803,4.487359486952164,4.487344907556473,4.487456639994012,4.48746772072843,4.487465164688137,4.487768073676884,4.487777984823706,4.488594736878802,4.488633718487588,4.489294921078134,4.489287080733634,4.489418049666193,4.491253355116882,4.492873890800208,4.493469583155527,4.470347816475919,4.469089199939964,4.468040722272926,4.466765587868529,4.466739751787031,4.466478959299063,4.466461014013201,4.466451276781041,4.466728142863581,4.466725441344469,4.486050844681507,4.487850829977172,4.466439629369988,4.464420002015173],10,null,null,{"interactive":true,"className":"","stroke":true,"color":"#03F","weight":5,"opacity":0.5,"fill":true,"fillColor":"#03F","fillOpacity":0.2},null,null,null,null,["ouvrage 4","ouvrage 7","ouvrage 8","ouvrage 11","ouvrage 12","ouvrage 15","ouvrage 17","ouvrage 19","ouvrage 20","ouvrage 23","ouvrage 24","ouvrage 25","ouvrage 26","ouvrage 27","ouvrage 28","ouvrage 30","ouvrage 31","ouvrage 32","ouvrage 33","ouvrage 34","ouvrage 35","ouvrage 38","ouvrage 40","ouvrage 42","ouvrage 44","ouvrage 45","ouvrage 46","ouvrage 46","ouvrage 47","ouvrage 48","ouvrage 50","ouvrage 51","ouvrage 52","ouvrage 63","ouvrage 65","ouvrage 69","ouvrage 71","ouvrage 73","ouvrage 74","ouvrage 76","ouvrage 78","ouvrage 79","ouvrage 88","ouvrage 90","ouvrage 43","ouvrage 91","ouvrage 93","ouvrage 94","ouvrage 95","ouvrage 96","ouvrage 99","ouvrage 100","ouvrage 104","ouvrage 105","ouvrage 106","ouvrage 107","ouvrage 136","ouvrage 139","ouvrage 141","ouvrage 142","ouvrage 143","ouvrage 144","ouvrage 145","ouvrage 147","ouvrage 148","ouvrage 152","ouvrage 154","ouvrage 155","ouvrage 156","ouvrage 158","ouvrage 161","ouvrage 162","ouvrage 163","ouvrage 10","ouvrage 114","ouvrage 118","ouvrage 119","ouvrage 120","ouvrage 121","ouvrage 123","ouvrage 124","ouvrage 134","ouvrage 135","ouvrage 103","ouvrage 111","ouvrage 125","ouvrage 128"],{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]}],"limits":{"lat":[43.63926305125837,43.6652752376211],"lng":[4.464420002015173,4.493469583155527]}},"evals":[],"jsHooks":[]}</script>
</div>
<div class="section level2">
<h2 id="create-reach-objects-between-nodes">Create reach objects between nodes<a class="anchor" aria-label="anchor" href="#create-reach-objects-between-nodes"></a>
</h2>
<p>We format the data frame to create the reach objects.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span><span class="op">$</span><span class="va">section_type</span> <span class="op">&lt;-</span> <span class="st">"R"</span></span>
<span><span class="va">df</span><span class="op">$</span><span class="va">section_type</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">DN_mm</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"C"</span></span>
<span><span class="va">df</span><span class="op">$</span><span class="va">section_width</span> <span class="op">&lt;-</span> <span class="va">df</span><span class="op">$</span><span class="va">`Largeur_Section (cm)`</span> <span class="op">/</span> <span class="fl">100</span></span>
<span><span class="va">df</span><span class="op">$</span><span class="va">section_radius</span> <span class="op">&lt;-</span> <span class="va">df</span><span class="op">$</span><span class="va">DN_mm</span> <span class="op">/</span> <span class="fl">2000</span></span>
<span><span class="va">df</span><span class="op">$</span><span class="va">section_bottom_elevation</span> <span class="op">&lt;-</span> <span class="va">df</span><span class="op">$</span><span class="va">Z</span></span>
<span><span class="va">df</span><span class="op">$</span><span class="va">section_height</span> <span class="op">&lt;-</span> <span class="va">df</span><span class="op">$</span><span class="va">`Hauteur_Section (m)`</span> <span class="op">/</span> <span class="fl">100</span></span>
<span><span class="va">df</span><span class="op">$</span><span class="va">abscissa</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">df</span><span class="op">$</span><span class="va">abscissa</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">df</span><span class="op">$</span><span class="va">abscissa</span><span class="op">[</span><span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">X</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="va">df</span><span class="op">$</span><span class="va">X</span><span class="op">[</span><span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">Y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="va">df</span><span class="op">$</span><span class="va">Y</span><span class="op">[</span><span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">df</span><span class="op">$</span><span class="va">regulator</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"regulation"</span>, <span class="va">df</span><span class="op">$</span><span class="va">Type_ouv</span><span class="op">)</span></span></code></pre></div>
<p>We create a function for creating a reach object from a table
representing sections objects.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">create_reach_from_sections</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">section_type</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">==</span> <span class="st">"R"</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">profile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>B <span class="op">=</span> <span class="va">df</span><span class="op">$</span><span class="va">section_width</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>                      ZF <span class="op">=</span> <span class="va">df</span><span class="op">$</span><span class="va">section_bottom_elevation</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>                      ZB <span class="op">=</span> <span class="va">df</span><span class="op">$</span><span class="va">section_bottom_elevation</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">+</span> <span class="va">df</span><span class="op">$</span><span class="va">section_height</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">section_type</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">==</span> <span class="st">"C"</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">profile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>R <span class="op">=</span> <span class="va">df</span><span class="op">$</span><span class="va">section_radius</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>                      ZF <span class="op">=</span> <span class="va">df</span><span class="op">$</span><span class="va">section_bottom_elevation</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>                      ZB <span class="op">=</span> <span class="va">df</span><span class="op">$</span><span class="va">section_bottom_elevation</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">+</span> <span class="va">df</span><span class="op">$</span><span class="va">section_radius</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">*</span> <span class="fl">2</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="fu"><a href="../reference/create_section_txt.html">create_section_txt</a></span><span class="op">(</span>section_name <span class="op">=</span> <span class="va">df</span><span class="op">$</span><span class="va">id</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>                       abscissa <span class="op">=</span> <span class="va">df</span><span class="op">$</span><span class="va">abscissa</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>                       section_type <span class="op">=</span> <span class="va">df</span><span class="op">$</span><span class="va">section_type</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>                       profile <span class="op">=</span> <span class="va">profile</span>, </span>
<span>                       singular <span class="op">=</span> <span class="va">df</span><span class="op">$</span><span class="va">regulator</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>                       xgeo <span class="op">=</span> <span class="va">df</span><span class="op">$</span><span class="va">X</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,</span>
<span>                       ygeo <span class="op">=</span> <span class="va">df</span><span class="op">$</span><span class="va">Y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Remove duplicate rows.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html" class="external-link">duplicated</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">abscissa</span><span class="op">)</span><span class="op">)</span>, <span class="op">]</span></span></code></pre></div>
<p>We generate a reach object from the table using the function we
created.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sections</span> <span class="op">&lt;-</span> <span class="fu">create_reach_from_sections</span><span class="op">(</span><span class="va">df</span><span class="op">)</span></span></code></pre></div>
<p>And then we split this reach into multiple reaches using location of
offtakes.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rows_nodes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="op">!</span><span class="va">df</span><span class="op">$</span><span class="va">regulator</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">regulator</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span><span class="op">]</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># The last row is a regulator: we need to add a downstream node</span></span>
<span>  <span class="va">rows_nodes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">rows_nodes</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">reaches</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">rows_nodes</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">sections</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="va">rows_nodes</span><span class="op">[</span><span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span>, <span class="va">rows_nodes</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="import-the-reaches-into-sic">Import the reaches into SIC<a class="anchor" aria-label="anchor" href="#import-the-reaches-into-sic"></a>
</h2>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/sic_import_reaches.html">sic_import_reaches</a></span><span class="op">(</span><span class="va">reaches</span>, import_mode <span class="op">=</span> <span class="st">"ImportXml_NEW"</span>, cfg <span class="op">=</span> <span class="va">cfg</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0</span></span></code></pre></div>
<p>Set some project parameter:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/set_project_params.html">set_project_params</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>DX <span class="op">=</span> <span class="fl">100</span>, </span>
<span>                        GeoUnit <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>, </span>
<span>                   cfg <span class="op">=</span> <span class="va">cfg</span><span class="op">)</span></span></code></pre></div>
<p>Add node names for facilitating searches in the network:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Extract rows concerning nodes from the table</span></span>
<span><span class="va">df_nodes</span> <span class="op">&lt;-</span> <span class="va">df</span><span class="op">[</span><span class="va">rows_nodes</span>, <span class="op">]</span></span>
<span><span class="fu"><a href="../reference/update_nodes_names.html">update_nodes_names</a></span><span class="op">(</span>new_names <span class="op">=</span> <span class="va">df_nodes</span><span class="op">$</span><span class="va">id</span>,</span>
<span>                   cfg <span class="op">=</span> <span class="va">cfg</span><span class="op">)</span></span></code></pre></div>
<p>Update reach connectivity to take branches into account:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rows_to_relocate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">df_nodes</span><span class="op">$</span><span class="va">Noeud_amont</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">xp</span> <span class="op">&lt;-</span> <span class="fu">xml2</span><span class="fu">::</span><span class="fu"><a href="http://xml2.r-lib.org/reference/read_xml.html" class="external-link">read_xml</a></span><span class="op">(</span><span class="va">cfg</span><span class="op">$</span><span class="va">project</span><span class="op">$</span><span class="va">path</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="va">rows_to_relocate</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">num_upstream_node</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_xml_num_by_name.html">get_xml_node_num_by_name</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"ouvrage"</span>, <span class="va">df_nodes</span><span class="op">$</span><span class="va">Noeud_amont</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>, xp <span class="op">=</span> <span class="va">xp</span><span class="op">)</span></span>
<span>  <span class="va">num_downstream_node</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_xml_num_by_name.html">get_xml_node_num_by_name</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"ouvrage"</span>, <span class="va">df_nodes</span><span class="op">$</span><span class="va">`ID Ouvrage`</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>, xp <span class="op">=</span> <span class="va">xp</span><span class="op">)</span></span>
<span>  <span class="va">num_reach</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_xml_reach_num_by_node_num.html">get_xml_reach_num_by_node_num</a></span><span class="op">(</span><span class="va">num_downstream_node</span>, upstream <span class="op">=</span> <span class="cn">FALSE</span>, xp <span class="op">=</span> <span class="va">xp</span><span class="op">)</span></span>
<span>  <span class="va">node</span> <span class="op">&lt;-</span> <span class="fu">xml2</span><span class="fu">::</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html" class="external-link">xml_find_first</a></span><span class="op">(</span><span class="va">xp</span>, <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"/Reseau/Liste_Biefs/Bief[%i]/Top/NoeudAm"</span>, <span class="va">num_reach</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu">xml2</span><span class="fu">::</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_text.html" class="external-link">xml_text</a></span><span class="op">(</span><span class="va">node</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">num_upstream_node</span><span class="op">)</span></span>
<span>  <span class="co"># Copy a section adjacent to the new upstream node in place of the old one</span></span>
<span>  <span class="va">section_num</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_xml_num_by_name.html">get_xml_section_num_by_name</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"ouvrage"</span>, <span class="va">df_nodes</span><span class="op">$</span><span class="va">Noeud_amont</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>, xp <span class="op">=</span> <span class="va">xp</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/copy_xml_section.html">copy_xml_section</a></span><span class="op">(</span>source_reach <span class="op">=</span> <span class="va">section_num</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, </span>
<span>                   source_section <span class="op">=</span> <span class="va">section_num</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,</span>
<span>                   target_reach <span class="op">=</span> <span class="va">num_reach</span>,</span>
<span>                   target_section <span class="op">=</span> <span class="fl">1</span>, </span>
<span>                   xp <span class="op">=</span> <span class="va">xp</span>, </span>
<span>                   write_xml <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"Replaced upstream node of reach num "</span>, <span class="va">num_reach</span>, <span class="st">" with the node "</span>, <span class="va">num_upstream_node</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; Replaced upstream node of reach num 36 with the node 23</span></span>
<span><span class="co">#&gt; Replaced upstream node of reach num 58 with the node 4</span></span>
<span><span class="co">#&gt; Replaced upstream node of reach num 66 with the node 40</span></span>
<span><span class="co">#&gt; Replaced upstream node of reach num 67 with the node 66</span></span>
<span><span class="fu">xml2</span><span class="fu">::</span><span class="fu"><a href="http://xml2.r-lib.org/reference/write_xml.html" class="external-link">write_xml</a></span><span class="op">(</span><span class="va">xp</span>, <span class="va">cfg</span><span class="op">$</span><span class="va">project</span><span class="op">$</span><span class="va">path</span><span class="op">)</span></span></code></pre></div>
<p>We add geolocation on the nodes and compute the coordinates of the
nodes in the EdiSIC display and the middle point of the reaches.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Manually enter coordinates of 2 nodes in EdiSic display (pixel coords)</span></span>
<span><span class="co"># to match EdiSIC background image with geoloc</span></span>
<span><span class="va">display_xy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>num <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">df_nodes</span><span class="op">$</span><span class="va">id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ouvrage 4"</span>, <span class="st">"ouvrage 44"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                         x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">341</span>, <span class="fl">592</span><span class="op">)</span>,</span>
<span>                         y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">54</span>, <span class="fl">467</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/add_node_geoloc.html">add_node_geoloc</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">df_nodes</span><span class="op">$</span><span class="va">X</span>, </span>
<span>                y <span class="op">=</span> <span class="va">df_nodes</span><span class="op">$</span><span class="va">Y</span>, </span>
<span>                display_xy <span class="op">=</span> <span class="va">display_xy</span>,</span>
<span>                cfg <span class="op">=</span> <span class="va">cfg</span><span class="op">)</span></span></code></pre></div>
<p>Now that some reaches have been moved, we need to update the
abscissas of the sections in each reach:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">xp</span> <span class="op">&lt;-</span> <span class="fu">xml2</span><span class="fu">::</span><span class="fu"><a href="http://xml2.r-lib.org/reference/read_xml.html" class="external-link">read_xml</a></span><span class="op">(</span><span class="va">cfg</span><span class="op">$</span><span class="va">project</span><span class="op">$</span><span class="va">path</span><span class="op">)</span></span>
<span><span class="va">xml_reaches</span> <span class="op">&lt;-</span> <span class="fu">xml2</span><span class="fu">::</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html" class="external-link">xml_find_all</a></span><span class="op">(</span><span class="va">xp</span>, <span class="st">"/Reseau/Liste_Biefs/Bief"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">xml_reaches</span>, <span class="kw">function</span><span class="op">(</span><span class="va">xml_reach</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">xml_sections</span> <span class="op">&lt;-</span> <span class="fu">xml2</span><span class="fu">::</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html" class="external-link">xml_find_all</a></span><span class="op">(</span><span class="va">xml_reach</span>, <span class="st">"Liste_Sections/SectionMin"</span><span class="op">)</span></span>
<span>  <span class="va">abscissa</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="va">previous_coords</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">xml_sections</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">coords</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_xml_geoloc.html">get_xml_geoloc</a></span><span class="op">(</span><span class="va">xml_sections</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">i</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">abscissa</span> <span class="op">&lt;-</span> <span class="va">abscissa</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="op">(</span><span class="va">coords</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="va">previous_coords</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="op">(</span><span class="va">coords</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">-</span> <span class="va">previous_coords</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="va">xml_sections</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu">xml2</span><span class="fu">::</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_attr.html" class="external-link">xml_set_attr</a></span><span class="op">(</span><span class="st">"abscisse"</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">abscissa</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">previous_coords</span> <span class="op">&lt;-</span> <span class="va">coords</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">xml2</span><span class="fu">::</span><span class="fu"><a href="http://xml2.r-lib.org/reference/write_xml.html" class="external-link">write_xml</a></span><span class="op">(</span><span class="va">xp</span>, <span class="va">cfg</span><span class="op">$</span><span class="va">project</span><span class="op">$</span><span class="va">path</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="run-talweg-on-it">Run Talweg on it<a class="anchor" aria-label="anchor" href="#run-talweg-on-it"></a>
</h2>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cfg</span><span class="op">$</span><span class="va">sic</span><span class="op">$</span><span class="va">fortran</span><span class="op">$</span><span class="va">prms</span><span class="op">$</span><span class="va">INTERF</span> <span class="op">&lt;-</span> <span class="fl">2</span> <span class="co"># visible interface (web license key bugs with INTERF=0)</span></span>
<span><span class="fu"><a href="../reference/sic_run_mesh.html">sic_run_mesh</a></span><span class="op">(</span>cfg <span class="op">=</span> <span class="va">cfg</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="import-regulators">Import regulators<a class="anchor" aria-label="anchor" href="#import-regulators"></a>
</h2>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">xml_regulator</span> <span class="op">&lt;-</span> <span class="fu">xml2</span><span class="fu">::</span><span class="fu"><a href="http://xml2.r-lib.org/reference/read_xml.html" class="external-link">read_xml</a></span><span class="op">(</span><span class="st">"template_regulator.xml"</span><span class="op">)</span></span>
<span><span class="va">xp</span> <span class="op">&lt;-</span> <span class="fu">xml2</span><span class="fu">::</span><span class="fu"><a href="http://xml2.r-lib.org/reference/read_xml.html" class="external-link">read_xml</a></span><span class="op">(</span><span class="va">cfg</span><span class="op">$</span><span class="va">project</span><span class="op">$</span><span class="va">path</span><span class="op">)</span></span>
<span><span class="va">xPath_regulator</span> <span class="op">&lt;-</span> <span class="st">"//SectionMin[@Nom='%s']"</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">regulator</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">node_width</span> <span class="op">&lt;-</span> <span class="fu">xml2</span><span class="fu">::</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html" class="external-link">xml_find_first</a></span><span class="op">(</span><span class="va">xml_regulator</span>, <span class="st">"//Largeur"</span><span class="op">)</span></span>
<span>  <span class="fu">xml2</span><span class="fu">::</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_text.html" class="external-link">xml_text</a></span><span class="op">(</span><span class="va">node_width</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">`Largeur_ouv (cm)`</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">/</span> <span class="fl">100</span><span class="op">)</span></span>
<span>  <span class="va">node_bottom_elevation</span> <span class="op">&lt;-</span> <span class="fu">xml2</span><span class="fu">::</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html" class="external-link">xml_find_first</a></span><span class="op">(</span><span class="va">xml_regulator</span>, <span class="st">"//CoteRadier"</span><span class="op">)</span></span>
<span>  <span class="fu">xml2</span><span class="fu">::</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_text.html" class="external-link">xml_text</a></span><span class="op">(</span><span class="va">node_bottom_elevation</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">Z</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">node_opening</span> <span class="op">&lt;-</span> <span class="fu">xml2</span><span class="fu">::</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html" class="external-link">xml_find_first</a></span><span class="op">(</span><span class="va">xml_regulator</span>, <span class="st">"//Ouverture"</span><span class="op">)</span></span>
<span>  <span class="fu">xml2</span><span class="fu">::</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_text.html" class="external-link">xml_text</a></span><span class="op">(</span><span class="va">node_opening</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">`Hauteur_ouv (m)`</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">/</span> <span class="fl">100</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">node_regulator</span> <span class="op">&lt;-</span> <span class="fu">xml2</span><span class="fu">::</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html" class="external-link">xml_find_first</a></span><span class="op">(</span><span class="va">xp</span>, <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="va">xPath_regulator</span>, <span class="va">df</span><span class="op">$</span><span class="va">id</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu">xml2</span><span class="fu">::</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_replace.html" class="external-link">xml_add_child</a></span><span class="op">(</span><span class="va">node_regulator</span>, <span class="va">xml_regulator</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu">xml2</span><span class="fu">::</span><span class="fu"><a href="http://xml2.r-lib.org/reference/write_xml.html" class="external-link">write_xml</a></span><span class="op">(</span><span class="va">xp</span>, <span class="va">cfg</span><span class="op">$</span><span class="va">project</span><span class="op">$</span><span class="va">path</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="import-offtakes">Import offtakes<a class="anchor" aria-label="anchor" href="#import-offtakes"></a>
</h2>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">xp</span> <span class="op">&lt;-</span> <span class="fu">xml2</span><span class="fu">::</span><span class="fu"><a href="http://xml2.r-lib.org/reference/read_xml.html" class="external-link">read_xml</a></span><span class="op">(</span><span class="va">cfg</span><span class="op">$</span><span class="va">project</span><span class="op">$</span><span class="va">path</span><span class="op">)</span></span>
<span><span class="va">xPath_node</span> <span class="op">&lt;-</span> <span class="st">"/Reseau/Liste_Noeuds/Noeud[@Nom='%s']"</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">df_nodes</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">xml_offtake</span> <span class="op">&lt;-</span> <span class="fu">xml2</span><span class="fu">::</span><span class="fu"><a href="http://xml2.r-lib.org/reference/read_xml.html" class="external-link">read_xml</a></span><span class="op">(</span><span class="st">"template_offtake.xml"</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">df_nodes</span><span class="op">$</span><span class="va">`DN (mm)`</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Rectangular gate</span></span>
<span>    <span class="va">node_circular_gate</span> <span class="op">&lt;-</span> <span class="fu">xml2</span><span class="fu">::</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html" class="external-link">xml_find_first</a></span><span class="op">(</span><span class="va">xml_offtake</span>, <span class="st">"//Ouvrage[@Type='VanneC']"</span><span class="op">)</span></span>
<span>    <span class="fu">xml2</span><span class="fu">::</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_replace.html" class="external-link">xml_remove</a></span><span class="op">(</span><span class="va">node_circular_gate</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="co"># Circular gate</span></span>
<span>    <span class="va">node_rectangular_gate</span> <span class="op">&lt;-</span> <span class="fu">xml2</span><span class="fu">::</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html" class="external-link">xml_find_first</a></span><span class="op">(</span><span class="va">xml_offtake</span>, <span class="st">"//Ouvrage[@Type='VanneR']"</span><span class="op">)</span></span>
<span>    <span class="fu">xml2</span><span class="fu">::</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_replace.html" class="external-link">xml_remove</a></span><span class="op">(</span><span class="va">node_rectangular_gate</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">node_width</span> <span class="op">&lt;-</span> <span class="fu">xml2</span><span class="fu">::</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html" class="external-link">xml_find_first</a></span><span class="op">(</span><span class="va">xml_offtake</span>, <span class="st">"//Largeur"</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">df_nodes</span><span class="op">$</span><span class="va">`DN (mm)`</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Rectangular gate</span></span>
<span>    <span class="fu">xml2</span><span class="fu">::</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_text.html" class="external-link">xml_text</a></span><span class="op">(</span><span class="va">node_width</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">df_nodes</span><span class="op">$</span><span class="va">`Largeur_ouv (cm)`</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">/</span> <span class="fl">100</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="co"># Circular gate</span></span>
<span>    <span class="fu">xml2</span><span class="fu">::</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_text.html" class="external-link">xml_text</a></span><span class="op">(</span><span class="va">node_width</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">df_nodes</span><span class="op">$</span><span class="va">`DN (mm)`</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">/</span> <span class="fl">1000</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">node_bottom_elevation</span> <span class="op">&lt;-</span> <span class="fu">xml2</span><span class="fu">::</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html" class="external-link">xml_find_first</a></span><span class="op">(</span><span class="va">xml_offtake</span>, <span class="st">"//CoteRadier"</span><span class="op">)</span></span>
<span>  <span class="fu">xml2</span><span class="fu">::</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_text.html" class="external-link">xml_text</a></span><span class="op">(</span><span class="va">node_bottom_elevation</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">df_nodes</span><span class="op">$</span><span class="va">Z</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">node_opening</span> <span class="op">&lt;-</span> <span class="fu">xml2</span><span class="fu">::</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html" class="external-link">xml_find_first</a></span><span class="op">(</span><span class="va">xml_offtake</span>, <span class="st">"//Ouverture"</span><span class="op">)</span></span>
<span>  <span class="fu">xml2</span><span class="fu">::</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_text.html" class="external-link">xml_text</a></span><span class="op">(</span><span class="va">node_opening</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">df_nodes</span><span class="op">$</span><span class="va">`Hauteur_ouv (m)`</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">/</span> <span class="fl">100</span><span class="op">)</span></span>
<span>  <span class="va">node_down_elevation</span> <span class="op">&lt;-</span> <span class="fu">xml2</span><span class="fu">::</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html" class="external-link">xml_find_first</a></span><span class="op">(</span><span class="va">xml_offtake</span>, <span class="st">"//CoteFixe"</span><span class="op">)</span></span>
<span>  <span class="fu">xml2</span><span class="fu">::</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_text.html" class="external-link">xml_text</a></span><span class="op">(</span><span class="va">node_down_elevation</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">df_nodes</span><span class="op">$</span><span class="va">Z</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">node_offtake</span> <span class="op">&lt;-</span> <span class="fu">xml2</span><span class="fu">::</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html" class="external-link">xml_find_first</a></span><span class="op">(</span><span class="va">xp</span>, <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="va">xPath_node</span>, <span class="va">df_nodes</span><span class="op">$</span><span class="va">id</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu">xml2</span><span class="fu">::</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_replace.html" class="external-link">xml_add_child</a></span><span class="op">(</span><span class="va">node_offtake</span>, <span class="va">xml_offtake</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu">xml2</span><span class="fu">::</span><span class="fu"><a href="http://xml2.r-lib.org/reference/write_xml.html" class="external-link">write_xml</a></span><span class="op">(</span><span class="va">xp</span>, <span class="va">cfg</span><span class="op">$</span><span class="va">project</span><span class="op">$</span><span class="va">path</span><span class="op">)</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by David Dorchies.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
